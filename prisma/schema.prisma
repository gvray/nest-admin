// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int         @id @default(autoincrement())
  userId       String      @unique @default(uuid())
  email        String?     @unique
  username     String      @unique
  nickname     String // 昵称，必须
  phone        String?     @unique
  password     String
  avatar       String?
  gender       Int?        // 性别：0-未知, 1-男, 2-女, 3-其他
  remark       String? // 备注信息
  status       Int         @default(1) // 0: 禁用, 1: 启用, 2: 审核中, 3: 封禁
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [departmentId])
  userPositions UserPosition[]
  userRoles    UserRole[]

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("UserCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID  
  updatedBy   User?   @relation("UserUpdatedBy", fields: [updatedById], references: [userId])

  // 反向关联 - 作为创建者/更新者的记录
  createdUsers     User[]           @relation("UserCreatedBy")
  updatedUsers     User[]           @relation("UserUpdatedBy")
  createdRoles     Role[]           @relation("RoleCreatedBy")
  updatedRoles     Role[]           @relation("RoleUpdatedBy")
  createdRolePerms RolePermission[] @relation("RolePermissionCreatedBy")
  createdResources Resource[]       @relation("ResourceCreatedBy")
  updatedResources Resource[]       @relation("ResourceUpdatedBy")
  createdPerms     Permission[]     @relation("PermissionCreatedBy")
  updatedPerms     Permission[]     @relation("PermissionUpdatedBy")
  createdDepartments Department[]     @relation("DepartmentCreatedBy")
  updatedDepartments Department[]     @relation("DepartmentUpdatedBy")
  createdPositions Position[]       @relation("PositionCreatedBy")
  updatedPositions Position[]       @relation("PositionUpdatedBy")
  createdUserPositions UserPosition[] @relation("UserPositionCreatedBy")
  createdUserRoles     UserRole[]     @relation("UserRoleCreatedBy")
  createdDictionaryTypes DictionaryType[] @relation("DictionaryTypeCreatedBy")
  updatedDictionaryTypes DictionaryType[] @relation("DictionaryTypeUpdatedBy")
  createdDictionaryItems DictionaryItem[] @relation("DictionaryItemCreatedBy")
  updatedDictionaryItems DictionaryItem[] @relation("DictionaryItemUpdatedBy")
  createdConfigs Config[] @relation("ConfigCreatedBy")
  updatedConfigs Config[] @relation("ConfigUpdatedBy")
  createdRoleDepartments RoleDepartment[] @relation("RoleDepartmentCreatedBy")
  updatedRoleDepartments RoleDepartment[] @relation("RoleDepartmentUpdatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Role {
  id              Int              @id @default(autoincrement())
  roleId          String           @unique @default(uuid())
  roleKey         String           @unique
  name            String           @unique
  description     String?
  remark          String? // 备注信息
  sort            Int              @default(0) // 排序权重
  status          Int              @default(1) // 0: 禁用, 1: 启用
  dataScope       Int              @default(1) // 数据权限：1-仅本人, 2-本部门, 3-本部门及以下, 4-自定义, 5-全部
  userRoles       UserRole[]
  rolePermissions RolePermission[]
  roleDepartments RoleDepartment[] // 角色-部门关联（一对多）

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("RoleCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("RoleUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("roles")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [permissionId], onDelete: Cascade)

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("RolePermissionCreatedBy", fields: [createdById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// 角色-部门关联表（一对多关系）
model RoleDepartment {
  id           Int        @id @default(autoincrement())
  roleId       String
  departmentId String
  role         Role       @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
  department   Department @relation(fields: [departmentId], references: [departmentId], onDelete: Cascade)

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("RoleDepartmentCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("RoleDepartmentUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleId, departmentId])
  @@map("role_departments")
}

model Resource {
  id          Int          @id @default(autoincrement())
  resourceId  String       @unique @default(uuid())
  name        String       @unique // 资源名称，如：用户管理、角色管理
  code        String       @unique // 资源代码，如：user, role, department
  type        ResourceType @default(MENU) // 资源类型：directory(目录)用于分组, menu(菜单)挂载权限点
  path        String? // 资源路径，如：/users, /api/users
  icon        String? // 图标
  parentId    String?
  parent      Resource?    @relation("ResourceHierarchy", fields: [parentId], references: [resourceId])
  children    Resource[]   @relation("ResourceHierarchy")
  permissions Permission[]
  status      Int          @default(1) // 0: 禁用, 1: 启用
  sort        Int          @default(0)
  description String?

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("ResourceCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("ResourceUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("resources")
}

enum ResourceType {
  DIRECTORY // 目录（仅作结构分组，不跳页面）
  MENU // 菜单项（跳转页面）
}

model Permission {
  id              Int              @id @default(autoincrement())
  permissionId    String           @unique @default(uuid())
  name            String           @unique // 权限名称，如：查看用户、创建用户
  code            String           @unique // 权限代码，如：user:view, user:create
  action          String // 操作类型：view(查看), create(创建), update(更新), delete(删除), export(导出), import(导入)
  resourceId      String // 关联的菜单资源UUID（只能挂在MENU类型的资源上）
  resource        Resource         @relation(fields: [resourceId], references: [resourceId], onDelete: Cascade)
  rolePermissions RolePermission[]
  description     String?

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("PermissionCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("PermissionUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("permissions")
}

model Department {
  id                 Int          @id @default(autoincrement())
  departmentId       String       @unique @default(uuid())
  name               String       @unique
  description        String?
  remark             String? // 备注信息
  parentId           String?
  manager            String?
  phone              String?
  email              String?
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [departmentId])
  children           Department[] @relation("DepartmentHierarchy")
  users              User[] // 部门下的用户
  roleDepartments    RoleDepartment[] // 角色-部门关联
  status             Int          @default(1) // 0: 禁用, 1: 启用
  sort               Int          @default(0)

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("DepartmentCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("DepartmentUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("departments")
}

model Position {
  id          Int     @id @default(autoincrement())
  positionId  String  @unique @default(uuid())
  name        String  @unique
  code        String  @unique
  description String?
  remark      String? // 备注信息
  userPositions UserPosition[]
  status      Int     @default(1) // 0: 禁用, 1: 启用
  sort        Int     @default(0)

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("PositionCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("PositionUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("positions")
}

model UserPosition {
  id         Int      @id @default(autoincrement())
  userId     String
  positionId String
  user       User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  position   Position @relation(fields: [positionId], references: [positionId], onDelete: Cascade)

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("UserPositionCreatedBy", fields: [createdById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, positionId])
  @@map("user_positions")
}

model UserRole {
  id         Int      @id @default(autoincrement())
  userId     String
  roleId     String
  user       User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role       Role     @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("UserRoleCreatedBy", fields: [createdById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, roleId])
  @@map("user_roles")
}

model DictionaryType {
  id          Int           @id @default(autoincrement())
  typeId      String        @unique @default(uuid())
  code        String        @unique // 字典类型编码
  name        String        @unique // 字典类型名称
  description String?       // 描述
  status      Int           @default(1) // 0: 禁用, 1: 启用
  sort        Int           @default(0) // 排序权重
  remark      String?       // 备注信息
  items       DictionaryItem[] // 字典项列表

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("DictionaryTypeCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("DictionaryTypeUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dictionary_types")
}

model DictionaryItem {
  id          Int            @id @default(autoincrement())
  itemId      String         @unique @default(uuid())
  typeCode    String         // 字典类型编码
  type        DictionaryType @relation(fields: [typeCode], references: [code], onDelete: Cascade)
  value       String         // 字典项值
  label       String         // 显示标签
  description String?        // 描述
  status      Int            @default(1) // 0: 禁用, 1: 启用
  sort        Int            @default(0) // 排序权重
  remark      String?        // 备注信息

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("DictionaryItemCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("DictionaryItemUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dictionary_items")
}
model Config {
  id          Int      @id @default(autoincrement())
  configId    String   @unique @default(uuid())
  key         String   @unique // 配置键
  value       String   // 配置值
  name        String   // 配置名称
  description String?  // 描述
  type        String   @default("string") // 配置类型: string, number, boolean, json
  group       String   @default("system") // 配置分组
  status      Int      @default(1) // 0: 禁用, 1: 启用
  sort        Int      @default(0) // 排序权重
  remark      String?  // 备注信息

  // 审计字段
  createdById String? // 创建者ID
  createdBy   User?   @relation("ConfigCreatedBy", fields: [createdById], references: [userId])
  updatedById String? // 更新者ID
  updatedBy   User?   @relation("ConfigUpdatedBy", fields: [updatedById], references: [userId])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("configs")
}

model LoginLog {
  id          Int      @id @default(autoincrement())
  account     String   // 登录用户名/邮箱/手机号
  ipAddress   String   // 登录IP地址
  userAgent   String?  // 用户代理信息
  status      Int      // 登录状态：1-成功, 0-失败
  loginType   String   @default("username") // 登录类型：username(用户名), email(邮箱), phone(手机号), wechat(微信), qq(QQ), alipay(支付宝), github(GitHub), google(Google)
  failReason  String?  // 失败原因
  location    String?  // 登录地点（可选，基于IP解析）
  device      String?  // 设备信息
  browser     String?  // 浏览器信息
  os          String?  // 操作系统信息

  createdAt DateTime @default(now())

  @@map("login_logs")
}

